# 🚀 Шпаргалка по быстрому тестированию

```
┌─────────────────────────────────────────────────────────────┐
│  БЫСТРОЕ ТЕСТИРОВАНИЕ VOLLEYBOT                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1️⃣  python test_bot.py    ← Запустить тестовый бот       │
│  2️⃣  Найти бота в Telegram  ← Открыть мессенджер           │
│  3️⃣  /start                 ← Включить бота                │
│  4️⃣  /balance               ← Проверить долги и кассу      │
│  5️⃣  /pay Алиса 300         ← Тест оплаты                  │
│  6️⃣  /pay Оплата зала       ← Тест оплаты зала             │
│  7️⃣  Ctrl+C                 ← Остановить (данные удалятся) │
│                                                             │
│  ✅ Основная БД не затрагивается                            │
│  ✅ Все изменения временные                                 │
│  ✅ Можно тестировать в любом чате                          │
└─────────────────────────────────────────────────────────────┘
```

## Самый простой способ протестировать бота

### 1. Запустите тестовый бот

```bash
python test_bot.py
```

**Что это даёт:**
- ✅ Временная БД (основная не затрагивается)
- ✅ Автоматически созданы 3 зала, 3 игрока, касса с 2500₽
- ✅ Можно тестировать в любом чате
- ✅ После остановки всё удаляется

**Предустановленные данные:**

| Данные | Значение |
|--------|----------|
| Понедельник | 150₽/игра, 6000₽/мес |
| Среда | бесплатно |
| Пятница | 150₽/игра, 4500₽/мес |
| Алиса | баланс: -300₽ |
| Борис | баланс: -150₽ |
| Карина | баланс: 0₽ |
| Касса | 2500₽ |

### 2. Взаимодействуйте с ботом

Найдите бота в Telegram и отправьте:

```
/start              - Включить бота
/help               - Справка по всем командам
/balance            - Показать долги и кассу
/schedule           - Расписание опросов
/subs               - Абонементы по дням
/player             - Список всех игроков
```

### 3. Тестирование финансов

```
/pay Алиса 300        - Алиса оплатила 300₽ (касса +300)
/pay Борис 150        - Борис оплатил 150₽ (касса +150)
/restore Карина -150  - Карине списали, но она не приходила (касса без изменений)
/pay Оплата зала      - Оплатить аренду зала из кассы
/balance              - Проверить итоги
```

### 4. Остановите бота

Нажмите `Ctrl+C` — все тестовые данные удалятся автоматически.

---

## 🏦 Сценарии для тестирования финансовой системы

### Сценарий 1: Оплата долга

```
1. /balance                   ← Алиса: -300₽, касса: 2500₽
2. /pay Алиса 300             ← Алиса платит
3. /balance                   ← Алиса: 0₽, касса: 2800₽
```

### Сценарий 2: Восстановление баланса

```
1. /balance                   ← Борис: -150₽, касса: 2500₽
2. /restore Борис 150         ← Борис не приходил
3. /balance                   ← Борис: 0₽, касса: 2500₽ (не изменилась!)
```

### Сценарий 3: Оплата зала из кассы

```
1. /balance                   ← Касса: 2500₽
2. /pay Оплата зала           ← Показывает: Понедельник (6000₽), Пятница (4500₽)
3. Нажать "Понедельник"       ← Касса: -3500₽
4. /pay Оплата зала           ← Показывает: только Пятница (Понедельник уже оплачен)
```

---

## 📅 Тестирование месячного опроса (абонемент)

Чтобы проверить расчёт абонемента и списание с подписчиков **без ожидания конца месяца**:

### Шаги

1. **Запустите тестовый бот** (в тестовой группе или личке):
   ```bash
   python test_bot.py
   ```

2. **Откройте месячный опрос вручную:**
   ```
   /open_monthly
   ```
   Бот отправит в чат опрос «Абонемент на следующий месяц» с вариантами залов (Понедельник, Пятница и т.д.).

3. **Проголосуйте** с одного или нескольких аккаунтов:
   - Выберите залы, по которым «подписка»
   - Можно несколько вариантов (несколько залов)

4. **Закройте опрос вручную:**
   ```
   /close_monthly
   ```
   Бот:
   - остановит опрос в Telegram;
   - посчитает стоимость на человека по каждому залу (`monthly_cost / число подписчиков`);
   - спишет сумму с баланса каждого подписчика;
   - отправит отчёт в чат и (если настроен) админу.

5. **Проверьте результат:**
   ```
   /balance
   ```
   Должны измениться балансы проголосовавших (сумма с подписчиков считается с учётом кассы, но баланс кассы не меняется — он уменьшается только при оплате залов).

### Важно

- Команды **только для администраторов**.
- Перед **закрытием** не открывайте обычные игровые опросы — иначе `/close_monthly` закроет первый попавшийся опрос. Для теста абонемента держите открытым только месячный опрос.
- Если платных залов нет (`cost > 0`), `/open_monthly` ответит: «Нет платных залов».

### Кратко

```
/open_monthly   → открыть опрос «Абонемент на следующий месяц»
   ↓
Проголосовать с нужных аккаунтов
   ↓
/close_monthly  → закрыть, посчитать и списать с балансов
   ↓
/balance        → проверить новые балансы и кассу
```

---

## 🔍 Получить Chat ID для настройки

```bash
python get_chat_id.py
```

1. Запустите скрипт
2. Отправьте боту сообщение (в личку или в группу)
3. Скопируйте Chat ID для использования в `.env`

```
Зачем нужен Chat ID?
├─ Для настройки CHAT_ID в .env
├─ Для тестирования в отдельной группе
└─ Для добавления новых админов (ADMIN_USER_ID)
```

---

## 👥 Тестирование с несколькими пользователями

1. Создайте тестовую группу в Telegram
2. Добавьте бота в группу и дайте ему права администратора
3. Пригласите друзей
4. Запустите `python test_bot.py`
5. Все могут взаимодействовать с ботом одновременно

---

## 🔘 Тестирование inline-кнопок

Если кнопки не работают:

1. Запустите `python test_bot.py`
2. Отправьте `/pay Оплата зала`
3. Нажмите на кнопку зала
4. Проверьте логи: должно быть `callback_query`

Если не работает — смотрите [docs/TESTING.md](docs/TESTING.md#проблема-inline-кнопки-не-работают)

```
Диагностика inline-кнопок:
✓ Кнопки отображаются?         → Да
✓ При нажатии что-то происходит? → Нет
✓ В логах есть "callback_query"? → Нет
  └─→ Проблема с allowed_updates в webhook
       Решение: /webhookinfo → Проверить список updates
```

---

## 🧪 Автоматические тесты

```bash
# Запустить все тесты
./manage.sh test

# Запустить с покрытием
pytest tests/ --cov=src --cov-report=html

# Запустить конкретный файл
pytest tests/test_calculate_subscription.py -v

# Запустить конкретный тест
pytest tests/test_fund_and_subscriptions.py::TestFundBalance -v
```

```
Покрытие кода: 62%+
├─ handlers.py               ✅ команды, /pay, /restore, callback'и
├─ services/poll_service.py   ✅ расчёт абонемента (calculate_subscription)
├─ db.py                      ✅ касса, оплата залов, транзакции
├─ types.py                   ✅ HallBreakdown, SubscriberCharge
└─ scheduler.py               ✅ планировщик
```

---

## 🐛 Отладка

### Включить подробные логи

В `.env`:
```bash
LOG_LEVEL=DEBUG
```

### Проверить webhook

```
/webhookinfo
```

```
Уровни логирования:
DEBUG   → Все детали (для разработки)
INFO    → Основные события (по умолчанию)
WARNING → Предупреждения
ERROR   → Ошибки
```

---

## 📚 Полная документация

Для детальной информации смотрите:
- [docs/TESTING.md](docs/TESTING.md) — подробное руководство
- [README.md](README.md) — основная документация
- [docs/CONFIGURATION.md](docs/CONFIGURATION.md) — настройка

```
Структура документации:
├─ TESTING_QUICKSTART.md  ← Вы здесь (быстрая шпаргалка)
├─ docs/TESTING.md         ← Подробное руководство
├─ README.md               ← Основная документация
└─ docs/CONFIGURATION.md   ← Настройка параметров
```

---

## ❓ Быстрые ответы на частые вопросы

**Q: Как тестировать без влияния на продакшен?**
A: Используйте `python test_bot.py` — создаётся временная БД

**Q: Inline-кнопки не работают?**
A: Проверьте `/webhookinfo` и убедитесь что `callback_query` в allowed_updates

**Q: Как протестировать /pay Оплата зала?**
A: Запустите `test_bot.py`, отправьте `/pay Оплата зала`, выберите зал из списка

**Q: Как протестировать месячный опрос (абонемент)?**
A: Запустите `test_bot.py` → `/open_monthly` → проголосуйте с аккаунтов → `/close_monthly` → проверьте `/balance`

**Q: Как убедиться, что /restore не меняет кассу?**
A: Сравните `/balance` до и после `/restore` — сумма кассы не должна измениться

**Q: Можно ли тестировать с друзьями?**
A: Да! Создайте тестовую группу, добавьте бота и друзей

**Q: Как сохранить тестовые данные между запусками?**
A: Запустите обычный бот с отдельной БД: `VOLLEYBOT_DB_PATH=data/test.db python -m src.bot`

---

## 🎨 Визуальная схема архитектуры тестирования

```
┌──────────────────────────────────────────────────────────────┐
│                    ТЕСТОВОЕ ОКРУЖЕНИЕ                         │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  test_bot.py                                                 │
│       │                                                      │
│       ├─→ Создаёт временную БД (/tmp/test_*.db)             │
│       │                                                      │
│       ├─→ Заполняет тестовыми данными                       │
│       │     ├─ 3 зала (Пн 6000₽, Ср бесплатно, Пт 4500₽) │
│       │     ├─ 3 игрока (Алиса -300₽, Борис -150₽, Карина) │
│       │     └─ Касса: 2500₽                                 │
│       │                                                      │
│       ├─→ Запускает бота (polling)                          │
│       │     ├─ Все команды доступны                         │
│       │     ├─ /pay, /restore, /balance, /pay Оплата зала   │
│       │     ├─ Планировщик активен                          │
│       │     └─ Работает в любом чате                        │
│       │                                                      │
│       └─→ При остановке (Ctrl+C)                            │
│             └─ Удаляет временную БД                         │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│  ПРОДАКШЕН ОКРУЖЕНИЕ (не затрагивается)                      │
│                                                              │
│  data/volleybot.db  ← Основная БД (в безопасности)           │
│  .env               ← Продакшен конфиг                       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 🛠️ Доступные инструменты

| Инструмент | Назначение | Команда |
|------------|------------|---------|
| `test_bot.py` | Тестовый бот с временной БД | `python test_bot.py` |
| `get_chat_id.py` | Получить ID чата | `python get_chat_id.py` |
| `manage.sh test` | Автоматические тесты (217 шт.) | `./manage.sh test` |

---

## 💡 Советы

1. **Быстрое тестирование финансов**: `python test_bot.py` → `/pay Алиса 300` → `/balance`
2. **Тест оплаты зала**: `/pay Оплата зала` → выбрать зал → `/balance` (касса уменьшилась)
3. **Тест восстановления**: `/restore Борис 150` → `/balance` (касса не изменилась)
4. **Несколько аккаунтов**: Создайте тестовую группу с друзьями
5. **Сохранить данные**: `VOLLEYBOT_DB_PATH=data/test.db python -m src.bot`
6. **Месячный опрос**: `python test_bot.py` → `/open_monthly` → голосовать → `/close_monthly`
7. **Debug режим**: `LOG_LEVEL=DEBUG python test_bot.py`
