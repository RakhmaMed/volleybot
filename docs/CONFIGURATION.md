# Руководство по конфигурации VolleyBot

Этот документ описывает все доступные параметры конфигурации бота и способы их настройки через переменные окружения.

## Способ настройки

Бот использует файл `.env` в корневой директории проекта для загрузки всех параметров. Также поддерживается установка переменных окружения напрямую.

### Начало работы

1. Скопируйте пример файла конфигурации:
   ```bash
   cp .env.example .env
   ```
2. Отредактируйте `.env`, указав ваши данные.
3. **Важно**: Никогда не добавляйте файл `.env` в систему контроля версий (git). Он уже включен в `.gitignore`.

---

## Параметры конфигурации (.env)

### Обязательные настройки Telegram

*   **`TELEGRAM_TOKEN`**: Токен вашего бота от [@BotFather](https://t.me/BotFather).
*   **`CHAT_ID`**: ID чата или группы, куда бот будет отправлять опросы (для групп начинается с `-100`).
*   **`ADMIN_USER_ID`**: Цифровой ID администратора Telegram. Используется для отправки системных уведомлений и отчетов. Управление ботом доступно всем администраторам группы.

### Настройки Webhook (опционально)

Если параметры не указаны, бот запускается в режиме **Polling** (подходит для тестов и локального запуска).

*   **`WEBHOOK_HOST`**: Публичный URL вашего сервера (например, `https://your-domain.com`).
*   **`WEBHOOK_PATH`**: Путь для вебхука (по умолчанию `/webhook`).
*   **`WEBHOOK_SECRET`**: Секретный токен для проверки подлинности запросов от Telegram.
*   **`WEBHOOK_PORT`**: Порт, который будет слушать бот (по умолчанию `8443`).
*   **`TRUST_PROXY`**: Разрешить доверие заголовкам `X-Forwarded-For` (по умолчанию `false`). Установите `true` при работе за Nginx.

### Настройки приложения

*   **`MIN_PLAYERS`**: Минимальное количество игроков (по умолчанию `12`).
*   **`MAX_PLAYERS`**: Максимальное количество игроков в основном составе (по умолчанию `18`).
*   **`RESERVE_PLAYERS`**: Количество мест для запасных игроков (по умолчанию `3`).
*   **`POLL_OPTIONS`**: Варианты ответов в опросе через запятую (по умолчанию `Да,Нет`).
*   **`SCHEDULER_TIMEZONE`**: Часовой пояс для планировщика (по умолчанию `UTC`).
*   **`LOG_LEVEL`**: Уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`).

---

## Конфигурация опросов (База Данных)

В отличие от системных настроек, **расписание опросов теперь хранится в базе данных SQLite** (`volleybot.db`).

Это позволяет изменять расписание "на лету" без перезагрузки бота.

### Параметры шаблона опроса в БД:
*   **`name`**: Уникальное техническое название опроса.
*   **`place`**: Место проведения (текстовое поле).
*   **`message`**: Текст сообщения, который будет отправлен в чат.
*   **`open_day`**: День недели для открытия (mon, tue, wed, thu, fri, sat, sun или `*`).
*   **`open_hour_utc` / `open_minute_utc`**: Время открытия опроса в формате UTC.
*   **`game_day`**: День проведения игры (день, когда опрос автоматически закроется).
*   **`game_hour_utc` / `game_minute_utc`**: Время начала игры в UTC (опрос закрывается за 30 минут до этого времени).

### Как управлять опросами
На данный момент управление опросами осуществляется напрямую через таблицу `poll_templates` в базе данных `volleybot.db` с помощью любого SQLite клиента. В будущих версиях будут добавлены административные команды в интерфейс бота.

---

## Работа со временем (UTC)

Все настройки времени в боте используют **UTC (Coordinated Universal Time)**.

**Пример для Москвы (MSK, UTC+3):**
*   Если вы хотите открыть опрос в 18:30 по Москве, укажите:
    *   Час: `15`
    *   Минуты: `30`

---

## Безопасность

1. **Защита данных**: База данных `volleybot.db` содержит балансы игроков и их ID. Ограничьте доступ к этому файлу на сервере.
2. **Секреты**: Никогда не передавайте ваш `TELEGRAM_TOKEN` и содержимое `.env` третьим лицам.

---

## Настройка за Nginx (Reverse Proxy)

Рекомендуемая схема развертывания для максимальной безопасности.

### 1. Настройка .env
```env
WEBHOOK_HOST=https://your-domain.com
TRUST_PROXY=true
WEBHOOK_SECRET=ваш_секретный_токен_тут
```

### 2. Настройка Nginx
Создайте конфиг `/etc/nginx/sites-available/volleybot`:

```nginx
server {
    server_name your-domain.com;
    listen 443 ssl;

    location /webhook {
        proxy_pass http://127.0.0.1:8443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SSL сертификаты (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
}
```

### 3. Безопасность портов
Убедитесь, что порт бота (`8443`) закрыт снаружи и доступен только локально. При использовании Docker с нашими скриптами управления (`manage.sh`), это настраивается автоматически через привязку к `127.0.0.1`.